#!/usr/bin/env ruby
require "json"

def run(command)
  puts command
  ret = `#{command}`
  puts "=> #{ret.inspect}"
  ret
end

unless ARGV[0] == "--skip-compile"
  if File.exist?("library.wasm")
    puts "--> Remove library.wasm"
    run("rm ./library.wasm")
    puts
  end

  puts "--> Compile"
  ret = run("make -f wasm.make")
end

puts
puts "--> Deploy"
ret = run("curl localhost:8000/module/ -F bytecode=@./library.wasm -F schema=@./test.schema")
module_id = JSON.parse(ret)["hash"]

puts
puts "--> Run"
json = <<JSON
{
  "money": {
    "subunits": 98,
    "iso_currency": "CAD"
  },
  "presentment_currency": "CAD",
  "shop_currency": "CAD"
}
JSON
run(%Q(curl localhost:8000/module/#{module_id} --data-ascii '#{json}'))
